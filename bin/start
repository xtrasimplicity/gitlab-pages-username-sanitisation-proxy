#!/usr/bin/env ruby
nginx_config_file = "/etc/nginx/conf.d/proxy.conf"
env_variables_to_substitute = %w(BASE_DOMAIN GITLAB_PAGES_SERVER_ADDRESS)
certificate_base_path = "/certs"

content = File.read(nginx_config_file)

env_variables_to_substitute.each do |env_var_name|
  content.gsub! "{{#{env_var_name}}}", ENV[env_var_name]
end

File.open(nginx_config_file, 'w') { |f| f.write content }

unless File.exist?("#{certificate_base_path}/cert.pem") and File.exist?("#{certificate_base_path}/key.pem")
  puts "Generating self-signed SSL certificates..."
  system "openssl req -x509 -newkey rsa:4096 -keyout #{certificate_base_path}/key.pem -out #{certificate_base_path}/cert.pem -days 365 -nodes -subj='/CN=*.#{ENV['BASE_DOMAIN']}'"
end

`nginx -g "daemon off;"`